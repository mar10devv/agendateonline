---
export const prerender = false;

import BarberiaLayout from "../../layouts/BarberiaLayout.astro";
import NavbarBarberia from "../../components/barberia/NavbarBarberia";
import HeroBarberia from "../../components/barberia/HeroBarberia";
import ServiciosBarberia from "../../components/barberia/ServiciosBarberia";
import { db } from "../../lib/firebase";
import { collection, query, where, getDocs } from "firebase/firestore";
import { fuentesMap, fuentesStyle } from "../../lib/fonts";

const { slug } = Astro.params;

let negocio = null;
const q = query(collection(db, "Negocios"), where("slug", "==", slug));
const snap = await getDocs(q);

if (!snap.empty) {
  negocio = snap.docs[0].data();
}

const hoverColor = negocio?.hoverColor || "#3b82f6";
const fuenteLogo = negocio?.fuenteLogo || "montserrat";
const fuenteBotones = negocio?.fuenteBotones || "poppins";
const fuenteTexto = negocio?.fuenteTexto || "raleway";

const modoImagenes = negocio?.modoImagenes || "defecto";

const heroImages =
  modoImagenes === "personalizado" && negocio?.bannerImages?.length
    ? negocio.bannerImages
    : ["/img/1.jpeg", "/img/2.jpg", "/img/3.jpg"];

const css = `
  :root {
    --hoverColor: ${hoverColor};
    --logoFont: ${fuentesStyle[fuenteLogo] || "sans-serif"};
  }

  .negocio a,
  .negocio button {
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .negocio a:hover,
  .negocio button:hover {
    background-color: var(--hoverColor);
    color: white;
    border-color: var(--hoverColor);
  }
`;
---

{!negocio ? (
  <h1 class="text-center text-2xl mt-10">‚ùå Este negocio no existe.</h1>
) : (
  <BarberiaLayout title={negocio.nombre}>
    <!-- üé® Inyectar estilos din√°micos -->
    <style is:global>{css}</style>

    <!-- ‚úÖ Navbar -->
    <NavbarBarberia
      title={negocio.nombre}
      hoverColor={hoverColor}
      logoUrl={negocio.usarLogo ? negocio.logoUrl : null}
      fuenteLogo={fuenteLogo}
      fuenteTexto={fuenteTexto}
      fuenteBotones={fuenteBotones}
      client:load
    />

    <!-- ‚úÖ Hero -->
    <HeroBarberia
      client:load
      images={heroImages}
      modoImagenes={modoImagenes}
      nombre={negocio.nombre}
      eslogan={negocio.eslogan}
      fuenteLogo={fuenteLogo}
      fuenteTexto={fuenteTexto}
      fuenteBotones={fuenteBotones}
    />

    <!-- ‚úÖ Secci√≥n botones -->
    <section class="negocio space-y-6 mt-6 p-6 border rounded bg-white shadow-sm">
      <a
        href="#servicios"
        class={`inline-block px-4 py-2 border rounded font-medium ${fuentesMap[fuenteBotones]}`}
      >
        Ver servicios
      </a>
      <button
        class={`px-4 py-2 border rounded font-medium ${fuentesMap[fuenteBotones]}`}
      >
        Reservar turno
      </button>
    </section>

    <!-- ‚úÖ Secci√≥n promo -->
    <section class="negocio mt-8 grid md:grid-cols-2 gap-4">
      <div class="border p-4 rounded shadow-sm hover:shadow-md">
        <h3 class={`font-bold mb-2 ${fuentesMap[fuenteTexto]}`}>üî• Promo destacada</h3>
        <p class={`${fuentesMap[fuenteTexto]}`}>
          {negocio.promo || "Primera visita con 20% de descuento"}
        </p>
      </div>
      <div class="border p-4 rounded shadow-sm hover:shadow-md">
        <h3 class={`font-bold mb-2 ${fuentesMap[fuenteTexto]}`}>‚≠ê Servicios m√°s populares</h3>
        <p class={`${fuentesMap[fuenteTexto]}`}>
          Corte + barba, Tinte, Peinados
        </p>
      </div>
    </section>

    <!-- üöÄ Nueva secci√≥n Servicios -->
    <div id="servicios" class="mt-16">
      <ServiciosBarberia />
    </div>
  </BarberiaLayout>
)}
